# Amaya 项目需求文档
Version：1.0.1-260129

## 引言
该项目的核心需求来源于：在繁杂的日常生活中，管理各种琐事与计划是比较恼人的。因此可以设计一个智能体来辅助完成这些任务。
由此，就有了Amaya，它不是传统意义上的Agent，Amaya也可以像一个普通的聊天机器人一样和用户聊天。由此，它不是为用户安排日程的全自动Agent，而更像是一个用户的伙伴，例如在规划日程或是计划时，Amaya需要遵循“提出方案→与用户确认→落地→监督提醒”的大致流程，如果用户否认方案或提出了修改要求，则要重新走一遍流程。
当然，除了安排日程，Amaya还要承担管理任务与提醒监督的职责。
需要注意的是，除了一些非常简单且明确的事情以外，LLM通常只能做出提案，而不能做出决策。

## 核心需求
1. 能够调用第三方 ChatGPT 接口（符合OpenAI API格式，但Base_Url是第三方的）, 用自然语言和用户沟通；
2. 能够分析理解和整理用户的各种任务和琐事；
3. 能够将任务写入到格式化的存储方式中；
4. 能够在日常的聊天中分析理解用户的生活习惯等内容并记录；
5. 能够进行一些简单的时间管理与任务安排，并与用户交流确认，然后担任用户的监督者，在合适的时间主动发消息提醒用户；
   - Amaya 可以主动发起非提醒类对话（如问候、关心进度等），但应避免在不合适的时间打扰用户（如深夜、清晨）；
6. 所有对日程的安排或修改都要显式的提醒用户，并告知修改内容；
7. 在需要提醒用户时，调用LLM生成最合适的消息内容，而不是机械的发送提醒；
8. 如果用户在提醒发送5分钟后仍然无交互，则采用更加可靠的提醒方式（不同优先级采取的策略不同，High: email + 推送APP(未来考虑接入), Medium: email, Low与None不进行二次提醒）；
   - 交互判定：用户发送任何消息，或点击 Telegram 消息下的快捷按钮（"收到"、"延后"、"本次取消"）均视为交互；
   - 高优先级任务在二次提醒后仍无响应，则采取更广泛的提醒方式或重复提醒；
9. 能够进行多轮次的对话，并至少具有一个可用的记忆系统（可以用现有的开源项目）；
10. 拥有一些特殊的 Tool Function, 允许 LLM 获取与用户有关的一些信息（比如：所在城市，目前的天气，节假日信息等等）；
11. 接入Telegram Bot，email等平台（Amaya主要通过即时通讯平台与用户交流）；
12. 能够正确识别发送消息的Telegram用户，并做好鉴权（应该有一张Telegram user id 与项目的 user_id 的关联表）；
13. 不同用户间的数据完全隔离（放在不同数据库或不同文件夹）；
14. 对于存储模块，具有明确的数据版本与迁移功能；

## 验收标准（测试驱动开发）

### LLM 模块
1.1. 内容：向 OpenAI API 发送一个多轮对话；期望：成功处理回复的内容。
1.2. 内容：向 Mock API 发送一个多轮对话；期望：多轮对话在新的终端窗口中显示，并请求用户的输入，随后将用户的输入正确返回给调用方。
1.3. 内容：主 LLM API 调用失败；期望：自动切换到备用接口并成功返回。
1.4. 内容：主备接口均失败；期望：提醒场景发送模板化消息，对话场景返回友好错误提示。

### 存储模块
2.1. 内容：对于 Task 的存储，测试 CRUD。
2.2. 内容：对于 ScheduleItem 的存储，测试 CRUD。
2.3. 内容：对于 User 配置的存储，测试 CRUD。

### Telegram Bot 模块
3.1. 内容：从 Telegram API 接收消息并回复；期望：复述用户发来的消息。
3.2. 内容：响应 Telegram 命令；期望：正确处理 /start, /online, /today, /help 等指令，响应后删除用户指令消息，回复消息下方附带"关闭"按钮。
3.3. 内容：用户点击快捷按钮（"收到"、"延后"、"本次取消"）；期望：正确更新提醒状态并给予反馈。

### Agent 核心模块
4.1. 内容：向 Amaya 发送一个模拟消息，考察 Amaya 向 LLM 发出的请求内容；期望：请求应包括"人设定义"、"World Context（时间、日程等）"、"历史对话"等内容。

### 提醒系统
5.1. 内容：创建 ScheduleItem 后等待触发；期望：在指定时间成功发送提醒消息。
5.2. 内容：发送提醒后用户 5 分钟无响应（High 优先级）；期望：触发 email 二次提醒。
5.3. 内容：发送提醒后用户 5 分钟无响应（Low 优先级）；期望：不触发二次提醒。
5.4. 内容：模拟凌晨触发 ScheduleItem 自动生成；期望：正确扫描当日 Task 并生成对应的 ScheduleItem。
5.5. 内容：High 优先级任务二次提醒后仍无响应；期望：每 3 分钟重复提醒，最多重复 3 次。

### 记忆系统
6.1. 内容：工作型记忆文件的读写；期望：能够正确读取和写入 conversation.md、plan.md、context.md。
6.2. 内容：对话上下文超出条数或 Token 长度限制；期望：触发摘要生成，近期对话被压缩并存入 conversation.md。

### 用户体验
7.1. 内容：用户快速连续发送多条消息；期望：正确排队处理，不丢失消息，并在最后合并处理结果，正确优雅地回复用户。

### 杂项
8.1. 内容：工具函数调用失败（如天气API超时）；期望：如果该函数不重要，就忽略；否则向用户返回友好提示，不中断对话。
8.2. 内容：用户设置时区为 Asia/Tokyo，创建"明天早上9点"的提醒；期望：正确转换为 UTC 存储并在 JST 9:00 触发。
8.3. 内容：服务收到 SIGTERM 信号时正在发送提醒；期望：完成当前提醒发送后再退出，不丢失数据。
8.4. 内容：创建"今天 23:59"的提醒，但当前时间已是 23:58；期望：正确处理或友好提示。
8.5. 内容：同一任务同时被用户修改和定时器触发；期望：无竞态条件，数据一致（可考虑采取串行的 Event List）。


## 非功能性需求
1. 支持为不同用户设置不同的时区；
2. 日志分级：TRACE / DEBUG / INFO / WARNING / ERROR / FATAL
   - INFO 及以上输出到控制台
   - 所有级别输出到日志文件
3. 不需要过度的加密设计（保留必要的权限控制）；
4. 可观测性：关键操作（任务创建、提醒发送）记录结构化日志，支持后续分析；
5. 优雅关闭：收到SIGTERM信号时，完成当前工作后再退出；

## 未来可能的需求（现在无需实现）
1. 接入 Dida365 Open API；
2. 接入其它的第三方 LLM API；

## 需要注意的地方
1. 记忆系统的数据应当分成“事实型记忆（偏好、作息、规则）”与“工作型记忆（近期任务上下文）”；
2. 对于时间与时区，所有时间均按照 UTC + Timezone(IANA) 存储（暂时不考虑跨时区旅行的情况）；
3. 在这个项目中，实际上存在两条主线：1. LLM驱动的对话生成系统（包括工具调用）；2. 事务系统（任务、日程、提醒、存储）；

**关于设计文档**：请查看 `HLD.zh-CN.md`
