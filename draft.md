# 项目草案：Amaya - 陪伴型人工智能

## 1. 项目愿景

开发一个基于大语言模型（LLM）的高度模块化、可扩展的陪伴型人工智能。项目核心目标是深度模拟人的思维模式、情感状态和行为习惯，创造一个有“生命感”的虚拟伙伴。

## 2. 核心设计理念

- **模块化驱动：** 将复杂的“人格”拆解为多个独立但相互关联的模块。
- **状态驱动的行为：** AI的行为和对话不仅是对用户输入的反应，更是其内部状态的综合体现。
- **自主生命周期：** AI拥有自己的“生活”，独立于用户交互。
- **结构化LLM交互：** 通过精心设计的Prompt和JSON格式的输入输出，引导LLM进行更深入、更符合角色设定的“思考”。

## 3. 系统架构

系统以一个中央**状态管理器 (`AmayaState`)** 为核心，由多个**状态处理模块**围绕其工作。

- **`state_manager.py`**: 定义 `AmayaState` 类，作为所有动态数据的唯一真实来源。
- **`main.py`**: 应用程序主入口，负责初始化、线程管理和用户交互循环。
- **核心模块 (`modules/`)**:
    - **`world_simulator.py`**: 时间处理器，更新 `AmayaState.current_time`。
    - **`physiological_model.py`**: 生理状态处理器，更新 `AmayaState.energy`。
    - **`psychological_model.py`**: 心理状态处理器，更新 `AmayaState.mood` 和 `AmayaState.favorability`。
    - **`memory_manager.py`**: **记忆处理器**。负责将新的记忆存入 `AmayaState`，并根据规则维护记忆池。
        - **短期记忆**: 一个结构化的消息列表，包含角色、内容和时间戳。其总长度受Token数量限制（例如2000 tokens），以确保API请求的效率。当超出限制时，最旧的记忆会被移除。
        - **长期记忆**: 作为所有对话的完整、永久存档。
    - **`scheduler.py`**: 日程安排器，根据时间更新 `AmayaState.current_action`。
    - **`prompt_manager.py`**: Prompt渲染器，从 `AmayaState` 读取数据并注入模板。
    - **`autonomous_agent.py`**: **自主代理 (大脑)**。系统的核心逻辑，负责调用LLM，解析响应，并调用其他处理器来更新 `AmayaState`。
    - **`logger.py`**: 日志记录器。

## 4. 架构改进：引入中央状态管理器

通过将所有动态数据集中到 `AmayaState`，我们实现了数据与逻辑的分离，提高了代码的可维护性。

## 5. 已实现的关键特性

- **动态内部状态**: AI的内部状态会实时变化并影响其行为。
- **计划任务**: AI拥有自己的日程。
- **LLM驱动的决策**: AI的行为由LLM根据其内部状态和用户输入进行决策。
- **可追溯的思考链**: 所有LLM交互都被记录下来，便于调试。
- **异步命令行交互**: 支持用户和AI随时发送消息。

## 6. 未来开发路线 (ToDo)

请参见 `todo.md` 文件。

## 7. 持久化存储

为了让 Amaya 的记忆和状态能够在程序重启后得以保留，我们设计了持久化存储机制。

- **存储策略**: 采用混合存储方案：
    - **SQLite 数据库**: 用于存储核心的、可扩展的记忆数据 (`full_memory_archive`)。这提供了事务安全、可扩展性和未来进行复杂查询的能力。
    - **JSON 文件**: 用于存储简单、快速读写的状态数据（如 `energy`, `mood`, `favorability` 等）。
- **`persistence_manager.py`**: 新增一个持久化管理模块，专门负责数据的保存和加载，将持久化逻辑与核心业务逻辑解耦。
- **数据流**:
    - **加载**: 程序启动时，`PersistenceManager` 从 SQLite 和 JSON 文件中读取数据，恢复 `AmayaState`。
    - **保存**:
        - 记忆会实时、增量地写入 SQLite 数据库。
        - 简单状态数据会在每次用户交互后和程序正常退出时保存到 JSON 文件。

## 8. 多用户系统

为了让 Amaya 能够与多位用户互动并分别记住他们，我们对系统进行了多用户改造。

- **用户识别与切换**: 系统在启动时会提示用户输入一个**用户ID**。这个ID将作为识别当前用户的唯一标识。不同的用户只需在启动时输入各自的ID，即可加载自己的专属状态和记忆。
- **数据持久化与隔离**:
    - **数据库层面**: 我们在核心的 `memories` 表中增加了 `user_id` 字段。这确保了每个用户的记忆都与他们的ID绑定，实现了记忆数据的完全隔离。
    - **状态存储**: 我们废弃了原有的 `state.json` 文件。取而代之的是，在数据库中创建了一个新的 `user_states` 表。该表以 `user_id` 为主键，存储每个用户独立的生理和心理状态（如精力、情绪、好感度等）。这使得状态管理更加健壮和集中化。
- **逻辑层面**: `PersistenceManager` 和 `AmayaState` 现在都与特定的 `user_id` 绑定，确保了在程序运行期间的所有操作（记忆读写、状态更新）都是针对当前登录用户的。

